package com.sd.mobile.ui

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import com.sd.mobile.data.remote.WeeklyItem
import kotlinx.coroutines.launch

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun WeeklyScreen(
    viewModel: WeeklyViewModel
) {
    val uiState by viewModel.uiState.collectAsState()
    val snackbarHostState = remember { SnackbarHostState() }
    val scope = rememberCoroutineScope()

    // ViewModel からのワンショットイベントを捕捉（Snackbar表示）
    LaunchedEffect(Unit) {
        viewModel.events.collect { event ->
            when (event) {
                is WeeklyUiEvent.ShowMessage -> {
                    snackbarHostState.showSnackbar(message = event.message)
                }
            }
        }
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("今週のおすすめ") },
                actions = {
                    TextButton(
                        onClick = { viewModel.reload() }
                    ) { Text("再読み込み") }
                }
            )
        },
        snackbarHost = {
            SnackbarHost(hostState = snackbarHostState)
        }
    ) { innerPadding ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
        ) {
            when (val state = uiState) {
                is WeeklyUiState.Loading -> {
                    // ローディング表示
                    CircularProgressIndicator(
                        modifier = Modifier.align(Alignment.Center)
                    )
                }

                is WeeklyUiState.Error -> {
                    // エラー表示＋再試行
                    ErrorView(
                        message = state.message,
                        onRetry = { viewModel.reload() }
                    )
                }

                is WeeklyUiState.Success -> {
                    if (state.items.isEmpty()) {
                        EmptyView(onReload = { viewModel.reload() })
                    } else {
                        WeeklyList(
                            items = state.items,
                            onTry = {
                                viewModel.onTryClicked()
                                scope.launch {
                                    snackbarHostState.showSnackbar("実行しました：${it.recommendation}")
                                }
                            }
                        )
                    }
                }
            }
        }
    }
}

@Composable
private fun ErrorView(
    message: String,
    onRetry: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(24.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Text("データの取得に失敗しました", style = MaterialTheme.typography.titleMedium)
        Spacer(Modifier.height(8.dp))
        Text(
            text = message,
            style = MaterialTheme.typography.bodyMedium
        )
        Spacer(Modifier.height(16.dp))
        Button(onClick = onRetry) {
            Text("もう一度ためす")
        }
    }
}

@Composable
private fun EmptyView(onReload: () -> Unit) {
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(24.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {
        Text("表示できるデータがありません", style = MaterialTheme.typography.titleMedium)
        Spacer(Modifier.height(8.dp))
        Button(onClick = onReload) { Text("再読み込み") }
    }
}

@Composable
private fun WeeklyList(
    items: List<WeeklyItem>,
    onTry: (WeeklyItem) -> Unit
) {
    LazyColumn(
        modifier = Modifier.fillMaxSize(),
        contentPadding = PaddingValues(12.dp),
        verticalArrangement = Arrangement.spacedBy(12.dp)
    ) {
        items(items) { item ->
            WeeklyCard(item = item, onTry = { onTry(item) })
        }
    }
}

@Composable
private fun WeeklyCard(
    item: WeeklyItem,
    onTry: () -> Unit
) {
    ElevatedCard(
        modifier = Modifier.fillMaxWidth(),
        shape = MaterialTheme.shapes.extraLarge
    ) {
        Column(Modifier.padding(16.dp)) {
            Text(
                text = item.recommendation,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.SemiBold,
                maxLines = 2,
                overflow = TextOverflow.Ellipsis
            )
            Spacer(Modifier.height(4.dp))
            Text(
                text = item.reason,
                style = MaterialTheme.typography.bodyMedium
            )
            Spacer(Modifier.height(12.dp))

            // メタ情報（日付 / 歩数 / ストレス平均）
            AssistChipRow(item = item)

            Spacer(Modifier.height(12.dp))
            FilledTonalButton(onClick = onTry) {
                Text("やってみる")
            }
        }
    }
}

@Composable
private fun AssistChipRow(item: WeeklyItem) {
    Row(
        horizontalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        AssistChip(
            onClick = {},
            label = { Text("日付：${item.date}") }
        )
        AssistChip(
            onClick = {},
            label = { Text("歩数：${item.steps}") }
        )
        AssistChip(
            onClick = {},
            label = { Text("平均ストレス：${"%.1f".format(item.stressAvg)}") }
        )
    }
}
